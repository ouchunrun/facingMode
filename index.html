<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>移动端切换前后摄像头</title>
    <script src="./vconsole.min.js"></script>
    <script>
        // init vConsole
        var vConsole = new VConsole();
        console.log('Hello world');
    </script>
    <style>
        button {
            height: 35px;
            width: 100%;
            margin-bottom: 15px;
            font-size: medium;
            font-family: cursive;
            color: black;
        }
    </style>
</head>
<body>

<button onclick="getCameraStream(true, 'exact')">点击开启前置摄像头(exact)</button>
<br>
<button onclick="getCameraStream(false, 'exact')">点击开启后置摄像头(exact)</button>
<br>

<button onclick="getCameraStream(true, 'ideal')">点击开启前置摄像头(ideal)</button>
<br>
<button onclick="getCameraStream(false, 'ideal')">点击开启后置摄像头(ideal)</button>
<br>

<button onclick="applyConstraints(360)">改变分辨率为360</button>
<br>
<button onclick="applyConstraints(480)">改变分辨率为480</button>

<video id="video" src=""></video>


<script>
    function applyConstraints(height) {
        var constraints = {
            frameRate: {
                max: 30,
                ideal:30
            },
            aspectRatio: { min: 1.777, max: 1.778 },
            width: {
                min: 0,
                ideal: 640,
                max: 640
            },
            height: {
                min: 0,
                ideal:height,
                max: height
            }
        };

        var localVideoTrack = window.stream.getVideoTracks()[0];
        localVideoTrack.applyConstraints(constraints).then(function () {
            console.info('applyConstraints succeed', JSON.stringify(constraints, null, '    '));

            var video = document.querySelector('video');
            // 旧的浏览器可能没有srcObject
            if ("srcObject" in video) {
                video.srcObject = stream;
            } else {
                // 防止在新的浏览器里使用它，应为它已经不再支持了
                video.src = window.URL.createObjectURL(stream);
            }
            video.onloadedmetadata = function (e) {
                video.play();
                console.warn("Stream dimensions for :" + video.videoWidth + "x" + video.videoHeight);
            };
        }).catch(function (error) {
            console.info("applyConstraints Error: ", error.name);
        })
    }
    
    function getCameraStream(type, limit) {
        var constraints = {
            audio: false,
            video: {}
        }
        var facingMode = type ? "user" : 'environment'
        if (limit === 'exact') {
            constraints.video.facingMode = {
                exact: facingMode
            }
        } else if (limit === 'ideal') {
            constraints.video.facingMode = {
                ideal: facingMode
            }
        }

        console.warn('constraints' + JSON.stringify(constraints, null, '    '))
        navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
            window.stream = stream
            console.warn("get stream success: " + JSON.stringify(constraints, null, '    '))
            var video = document.querySelector('video');
            // 旧的浏览器可能没有srcObject
            if ("srcObject" in video) {
                video.srcObject = stream;
            } else {
                // 防止在新的浏览器里使用它，应为它已经不再支持了
                video.src = window.URL.createObjectURL(stream);
            }
            video.onloadedmetadata = function (e) {
                video.play();
                console.warn("Stream dimensions for :" + video.videoWidth + "x" + video.videoHeight);
            };
        }).catch(function (err) {
            console.error(err);
            console.error(err.toString());
            if (err.name === 'NotReadableError') {
                console.warn("NotReadableError!!!!!!!!!!!!!")
                var constraints = {
                    audio: false,
                    video: {
                        facingMode: facingMode
                    }
                }

                console.warn('constraints is :' + JSON.stringify(constraints, null, '    '))
                navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                    window.stream = stream
                    console.warn("get stream success al: " + JSON.stringify(constraints, null, '    '))
                    var video = document.querySelector('video');
                    // 旧的浏览器可能没有srcObject
                    if ("srcObject" in video) {
                        video.srcObject = stream;
                    } else {
                        // 防止在新的浏览器里使用它，应为它已经不再支持了
                        video.src = window.URL.createObjectURL(stream);
                    }
                    video.onloadedmetadata = function (e) {
                        video.play();
                        console.warn("Stream dimensions for :" + video.videoWidth + "x" + video.videoHeight);
                    };
                }).catch(function (error) {
                    console.error(error)
                    var constraints = {
                        audio: false,
                        video: true
                    }

                    console.warn('not use facingMode constraints is :' + JSON.stringify(constraints, null, '    '))
                    navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                        window.stream = stream
                        console.warn("stream： ", stream)
                        console.warn("get stream success")
                        var video = document.querySelector('video');
                        // 旧的浏览器可能没有srcObject
                        if ("srcObject" in video) {
                            video.srcObject = stream;
                        } else {
                            // 防止在新的浏览器里使用它，应为它已经不再支持了
                            video.src = window.URL.createObjectURL(stream);
                        }
                        video.onloadedmetadata = function (e) {
                            video.play();
                            console.warn("Stream dimensions for :" + video.videoWidth + "x" + video.videoHeight);
                        };
                    }).catch(function (error) {
                        console.error(error)
                    })

                })
            }
        })
    }

</script>
</body>
</html>