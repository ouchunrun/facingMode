<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>移动端切换前后摄像头</title>
    <script src="./vconsole.min.js"></script>
    <script>
        // init vConsole
        var vConsole = new VConsole();
        console.log('Hello world');
    </script>
    <style>
        button {
            height: 35px;
            width: 100%;
            margin-bottom: 15px;
            font-size: medium;
            font-family: cursive;
            color: black;
        }
    </style>
</head>
<body>

<button onclick="getCameraStream(true, 'exact')">点击开启前置摄像头(exact)</button>
<br>
<button onclick="getCameraStream(false, 'exact')">点击开启后置摄像头(exact)</button>
<br>

<button onclick="getCameraStream(true, 'ideal')">点击开启前置摄像头(ideal)</button>
<br>
<button onclick="getCameraStream(false, 'ideal')">点击开启后置摄像头(ideal)</button>
<br>

<button onclick="applyConstraints(360)">改变分辨率为360</button>
<br>
<button onclick="applyConstraints(480)">改变分辨率为480</button>

<video id="video" src=""></video>


<script>
    function applyConstraints(height) {
        var constraints = {
            frameRate: {
                max: 30,
                ideal:30
            },
            aspectRatio: { min: 1.777, max: 1.778 },
            width: {
                min: 0,
                ideal: 360,
                max: 360
            },
            height: {
                min: 0,
                ideal:height,
                max: height
            }
        };

        var localVideoTrack = window.stream.getVideoTracks()[0];
        localVideoTrack.applyConstraints(constraints).then(function () {
            console.info('applyConstraints succeed', JSON.stringify(constraints, null, '    '));
        }).catch(function (error) {
            console.info("applyConstraints Error: ", error.name);
        })
    }
    
    function getCameraStream(type, limit) {
        var  constraints = {
            audio: false,
            video: {}
            //     {
            //     facingMode:{
            //         ideal:  "user"
            //     },
            //     width: { min: 0, ideal: 1280, max: 1920 },
            //     height: { min: 0, ideal: 720, max: 1080 }
            // }
        }
        if(limit === 'exact'){
            if(type){
                console.log("facingMode: user")
                constraints.video.facingMode = {
                    exact: "user"
                }
            }else {
                console.log("facingMode: environment")
                constraints.video.facingMode = {
                    exact: "environment"
                }
            }
        }else if(limit === 'ideal'){
            if(type){
                console.log("facingMode: user")
                constraints.video.facingMode = {
                    ideal: "user"
                }
            }else{
                console.log("facingMode: environment")
                constraints.video.facingMode = {
                    ideal: "environment"
                }
            }
        }

        console.warn('constraints' + JSON.stringify(constraints, null, '    '))


        // 老的浏览器可能根本没有实现 mediaDevices，所以我们可以先设置一个空的对象
        if (navigator.mediaDevices === undefined) {
            navigator.mediaDevices = {};
        }

        // 一些浏览器部分支持 mediaDevices。我们不能直接给对象设置 getUserMedia
        // 因为这样可能会覆盖已有的属性。这里我们只会在没有getUserMedia属性的时候添加它。
        if (navigator.mediaDevices.getUserMedia === undefined) {
            navigator.mediaDevices.getUserMedia = function(constraints) {

                // 首先，如果有getUserMedia的话，就获得它
                var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;

                // 一些浏览器根本没实现它 - 那么就返回一个error到promise的reject来保持一个统一的接口
                if (!getUserMedia) {
                    return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                }

                // 否则，为老的navigator.getUserMedia方法包裹一个Promise
                return new Promise(function(resolve, reject) {
                    getUserMedia.call(navigator, constraints, resolve, reject);
                });
            }
        }

        if(navigator.mediaDevices.getUserMedia){
            console.warn("navigator.mediaDevices.getUserMedia")
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    window.stream = stream
                    console.warn("get stream success")
                    var video = document.querySelector('video');
                    // 旧的浏览器可能没有srcObject
                    if ("srcObject" in video) {
                        video.srcObject = stream;
                    } else {
                        // 防止在新的浏览器里使用它，应为它已经不再支持了
                        video.src = window.URL.createObjectURL(stream);
                    }
                    video.onloadedmetadata = function(e) {
                        video.play();
                    };
                })
                .catch(function(err) {
                    console.error(err.name + ": " + err.message);
                });
        }else if(navigator.getUserMedia){
            console.warn("navigator.getUserMedia")
            navigator.getUserMedia(constraints, function (stream) {
                console.warn("get stream success")
                var video = document.querySelector('video');
                // 旧的浏览器可能没有srcObject
                if ("srcObject" in video) {
                    video.srcObject = stream;
                } else {
                    // 防止在新的浏览器里使用它，应为它已经不再支持了
                    video.src = window.URL.createObjectURL(stream);
                }
                video.onloadedmetadata = function(e) {
                    video.play();
                };
            }, function (err) {
                console.error(err.name + ": " + err.message);
            })
        }
    }

    var videoE = document.getElementById('video')
    videoE.onloadedmetadata = function () {
        console.warn("Stream dimensions for :" + videoE.videoWidth + "x" + videoE.videoHeight);
    }
</script>
</body>
</html>