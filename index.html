<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>移动端切换前后摄像头</title>
    <script src="./vconsole.min.js"></script>
    <script>
        // init vConsole
        var vConsole = new VConsole();
        console.log('Hello world');
    </script>
    <style>
        button {
            height: 35px;
            width: 100%;
            margin-bottom: 15px;
            font-size: medium;
            font-family: cursive;
            color: black;
        }
        select{
            width: 100%;
            height: 30px;
        }
    </style>
</head>
<body>

<button onclick="getCameraStream(true, 'exact')">点击开启前置摄像头(exact)</button>
<br>
<button onclick="getCameraStream(false, 'exact')">点击开启后置摄像头(exact)</button>
<br>

<button onclick="getCameraStream(true, 'ideal')">点击开启前置摄像头(ideal)</button>
<br>
<button onclick="getCameraStream(false, 'ideal')">点击开启后置摄像头(ideal)</button>
<br>

<button onclick="applyConstraints(360)">改变分辨率为360</button>
<br>
<button onclick="applyConstraints(480)">改变分辨率为480</button>

<!--设备选择区域-->
<div>
<!--    <div class="outputSelector device-mask">-->
<!--        <div class="audio-tag">Select audio output</div>-->
<!--        <select class="deviceSelect" id="audioList" onchange='switchAudioSource()'>-->
<!--            <option value="default">请选择</option>-->
<!--        </select>-->
<!--    </div>-->

    <div class="outputSelector device-mask">
        <div class="video-tag">Select video output</div>
        <select class="deviceSelect" id="videoList" onchange="shareVideo()">
            <option value="default">请选择</option>
        </select>
    </div>
</div>


<video autoplay id="video" src=""></video>


<script>
    function browserPlatformDetection() {
        var system = {}
        var np = navigator.platform;
        var ua = navigator.userAgent;
        system.win = np.indexOf("Win") === 0;
        system.mac = np.indexOf("Mac") === 0;
        system.xll = (np === "X11") || (np.indexOf("Linux") === 0);
        var isMobile = /Android|SymbianOS|Windows Phone|webOS|iPhone|iPad|iPod|BlackBerry/i.test(ua);
        var isPc = (system.win || system.mac || system.xll) && !isMobile;
        console.warn("isPc: ", isPc)
        console.warn("isMobile: ", isMobile)
        return {
            isMobile: isMobile,
            isPc: isPc
        }
    }
    browserPlatformDetection()


    function enumDevices(deviceInfoCallback) {
        if (navigator.mediaDevices === undefined || navigator.mediaDevices.enumerateDevices === undefined) {
            console.error("browser don't support enumerate devices")
            return
        }

        navigator.mediaDevices.enumerateDevices().then(function (deviceInfos) {
            var microphone = []
            var speaker = []
            var camera = []
            var screenResolution = []
            var isConstraintsKeywordSupport = true
            for (var i = 0; i < deviceInfos.length; i++) {
                var deviceInfo = deviceInfos[i]
                if(deviceInfo.deviceId === 'default' || deviceInfo.deviceId === 'communications'){
                    continue
                }
                if (deviceInfo.kind === 'audioinput') {
                    microphone.push({
                        label: deviceInfo.label,
                        deviceId: deviceInfo.deviceId,
                        groupId: deviceInfo.groupId,
                        status: 'available',
                    })
                }
                if (deviceInfo.kind === 'audiooutput') {
                    speaker.push({
                        label: deviceInfo.label,
                        deviceId: deviceInfo.deviceId,
                        groupId: deviceInfo.groupId,
                        status: 'available',
                    })
                }
                if (deviceInfo.kind === 'videoinput') {
                    camera.push({
                        label: deviceInfo.label,
                        deviceId: deviceInfo.deviceId,
                        groupId: deviceInfo.groupId,
                        status: 'available',
                        capability: []
                    })
                }
            }

            screenResolution.push({
                width: window.screen.width,
                height: window.screen.height,
            })

            var result = {
                microphones: microphone,
                speakers: speaker,
                cameras: camera,
                screenResolution: screenResolution,
                isConstraintsKeywordSupport: isConstraintsKeywordSupport
            }

            console.warn("deviceInfos: ", JSON.stringify(result.cameras, null, ' '))
            deviceInfoCallback(result)
            // return result
        }).catch(function (err) {
            console.error(err)
        })
    }
    
    
    (function () {
        enumDevices(deviceInfo => {
            let videoInputList = []
            let audioOutputList = []
            console.warn("deviceInfo.cameras: ", deviceInfo.cameras)
            if (deviceInfo.cameras) {
                videoInputList.push('<option>请选择</option>>')
                for (let i = 0; i < deviceInfo.cameras.length; i++) {
                    if (!deviceInfo.cameras[i].label) {
                        deviceInfo.cameras[i].label = 'camera' + i
                    }
                    videoInputList.push('<option class="cameraOption" value="' + deviceInfo.cameras[i].deviceId + '">' + deviceInfo.cameras[i].label + '</option>')
                    console.log('camera: ' + deviceInfo.cameras[i].label)
                }
                document.getElementById('videoList').innerHTML = videoInputList.join('')
            }

            // let audioOutput = deviceInfo.speakers.length > 0 ? deviceInfo.speakers : deviceInfo.microphones
            // console.warn("get audioOutput: ", audioOutput)
            // if(audioOutput){
            //     for (let j = 0; j < audioOutput.length; j++) {
            //         if (!audioOutput[j].label) {
            //             audioOutput[j].label = 'speakers' + j
            //         }
            //         // 过滤default 和 communications 类型
            //         if(audioOutput[j].deviceId !== 'default' && audioOutput[j].deviceId !== 'communications'){
            //             audioOutputList.push('<option class="cameraOption" value="' + audioOutput[j].deviceId + '">' + audioOutput[j].label + '</option>')
            //             console.log('speakers: ' + audioOutput[j].label)
            //         }
            //     }
            //     document.getElementById('audioList').innerHTML = audioOutputList.join('')
            // }
        }, function (error) {
            console.error('enum device error: ' + error)
        })
    })()


    function shareVideo(){
        let videoList = document.getElementById('videoList').options
        if(videoList && videoList.length > 0){
            let selectDevice = videoList[videoList.selectedIndex]
            console.warn("selectDevice: ", selectDevice.label)
            var deviceId = selectDevice.value

            var constraints = {
                audio: false,
                video: {
                    width: {
                        min: 0,
                        ideal: 1280,
                        max: 1280
                    },
                    height: {
                        min: 0,
                        ideal: 720,
                        max: 720
                    },
                    deviceId: {
                        exact: deviceId
                    }
                }
            }

            console.warn('not use facingMode constraints is :' + JSON.stringify(constraints, null, '    '))
            navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                window.stream = stream
                console.warn("get stream success")
                var video = document.querySelector('video');
                // 旧的浏览器可能没有srcObject
                if ("srcObject" in video) {
                    video.srcObject = stream;
                } else {
                    // 防止在新的浏览器里使用它，应为它已经不再支持了
                    video.src = window.URL.createObjectURL(stream);
                }
                video.onloadedmetadata = function (e) {
                    console.warn("Stream dimensions for :" + video.videoWidth + "x" + video.videoHeight);
                    video.play();
                };
            }).catch(function (error) {
                console.error(error)
            })

        }else {
            alert('No device here! plug device and Try again!')
        }
    }



    function applyConstraints(height) {
        var constraints = {
            frameRate: {
                max: 30,
                ideal:30
            },
            aspectRatio: { min: 1.777, max: 1.778 },
            width: {
                min: 0,
                ideal: 640,
                max: 640
            },
            height: {
                min: 0,
                ideal:height,
                max: height
            }
        };

        var localVideoTrack = window.stream.getVideoTracks()[0];
        localVideoTrack.applyConstraints(constraints).then(function () {
            console.info('applyConstraints succeed', JSON.stringify(constraints, null, '    '));

            var video = document.querySelector('video');
            // 旧的浏览器可能没有srcObject
            if ("srcObject" in video) {
                video.srcObject = stream;
            } else {
                // 防止在新的浏览器里使用它，应为它已经不再支持了
                video.src = window.URL.createObjectURL(stream);
            }
            video.onloadedmetadata = function (e) {
                video.play();
                console.warn("Stream dimensions for :" + video.videoWidth + "x" + video.videoHeight);
            };
        }).catch(function (error) {
            console.info("applyConstraints Error: ", error.name);
        })
    }
    
    function getCameraStream(type, limit) {
        var constraints = {
            audio: false,
            video: {}
        }
        var facingMode = type ? "user" : 'environment'
        if (limit === 'exact') {
            constraints.video.facingMode = {
                exact: facingMode
            }
        } else if (limit === 'ideal') {
            constraints.video.facingMode = {
                ideal: facingMode
            }
        }

        console.warn('constraints' + JSON.stringify(constraints, null, '    '))
        navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
            window.stream = stream
            console.warn("get stream success: " + JSON.stringify(constraints, null, '    '))
            var video = document.querySelector('video');
            // 旧的浏览器可能没有srcObject
            if ("srcObject" in video) {
                video.srcObject = stream;
            } else {
                // 防止在新的浏览器里使用它，应为它已经不再支持了
                video.src = window.URL.createObjectURL(stream);
            }
            video.onloadedmetadata = function (e) {
                video.play();
                console.warn("Stream dimensions for :" + video.videoWidth + "x" + video.videoHeight);
            };
        }).catch(function (err) {
            console.error(err);
            console.error(err.toString());
            if (err.name === 'NotReadableError') {
                console.warn("NotReadableError!!!!!!!!!!!!!")
                var constraints = {
                    audio: false,
                    video: {
                        facingMode: facingMode
                    }
                }

                console.warn('constraints is :' + JSON.stringify(constraints, null, '    '))
                navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                    window.stream = stream
                    console.warn("get stream success al: " + JSON.stringify(constraints, null, '    '))
                    var video = document.querySelector('video');
                    // 旧的浏览器可能没有srcObject
                    if ("srcObject" in video) {
                        video.srcObject = stream;
                    } else {
                        // 防止在新的浏览器里使用它，应为它已经不再支持了
                        video.src = window.URL.createObjectURL(stream);
                    }
                    video.onloadedmetadata = function (e) {
                        video.play();
                        console.warn("Stream dimensions for :" + video.videoWidth + "x" + video.videoHeight);
                    };
                }).catch(function (error) {
                    console.error(error)
                    var constraints = {
                        audio: false,
                        video: true
                    }

                    console.warn('not use facingMode constraints is :' + JSON.stringify(constraints, null, '    '))
                    navigator.mediaDevices.getUserMedia(constraints).then(function (stream) {
                        window.stream = stream
                        console.warn("stream： ", stream)
                        console.warn("get stream success")
                        var video = document.querySelector('video');
                        // 旧的浏览器可能没有srcObject
                        if ("srcObject" in video) {
                            video.srcObject = stream;
                        } else {
                            // 防止在新的浏览器里使用它，应为它已经不再支持了
                            video.src = window.URL.createObjectURL(stream);
                        }
                        video.onloadedmetadata = function (e) {
                            video.play();
                            console.warn("Stream dimensions for :" + video.videoWidth + "x" + video.videoHeight);
                        };
                    }).catch(function (error) {
                        console.error(error)
                    })

                })
            }
        })
    }

</script>
</body>
</html>